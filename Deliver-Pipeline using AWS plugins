pipeline {
  agent any
  
  environment {
      region = 'ap-northeast-1'
  }
  
    stages {
        stage ('Pull') {
            steps {
                git 'https://github.com/cloudmaster2025/sonar.git'
            }
        }
        stage ('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        stage ('Test') {
            steps {
              withSonarQubeEnv(installationName: 'Sonar', credentialsId: 'Sonar-Token') {
                sh ''' mvn clean verify sonar:sonar \
                       -Dsonar.projectKey=studentapp '''
                }
            }
        }
        stage ('Quality-Check') {
            steps {
              timeout(time: 30, unit: 'SECONDS') {
                  waitForQualityGate abortPipeline: true, credentialsId: 'Sonar-Token'
                }
            }
        }
        stage ('Deliver') {
            steps {
                withAWS(credentials: 'AWS-Keys', region: "${region}") {
                sh 'aws s3 cp target/*.war s3://bucket-96175'
                }
            }
        }
    }
}
